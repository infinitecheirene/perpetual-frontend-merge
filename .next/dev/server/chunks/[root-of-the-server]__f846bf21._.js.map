{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/raiza/OneDrive/Documents/Github/perpetual_merged/perpetual_frontend/app/api/send-bulk-email/route.ts"],"sourcesContent":["// app/api/send-bulk-email/route.ts\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport nodemailer from 'nodemailer';\r\n\r\n// Create transporter\r\nconst transporter = nodemailer.createTransport({\r\n  host: process.env.SMTP_HOST,\r\n  port: parseInt(process.env.SMTP_PORT || '587'),\r\n  secure: process.env.SMTP_SECURE === 'true',\r\n  auth: {\r\n    user: process.env.SMTP_USER,\r\n    pass: process.env.SMTP_PASS,\r\n  },\r\n});\r\n\r\n// Email templates\r\nconst emailTemplates = {\r\n  announcement: (data: any) => ({\r\n    subject: `New Announcement: ${data.title}`,\r\n    html: `\r\n      <!DOCTYPE html>\r\n      <html>\r\n      <head>\r\n        <style>\r\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n          .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n          .header { background: linear-gradient(135deg, #059669 0%, #f97316 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\r\n          .content { background: #f9fafb; padding: 30px; }\r\n          .badge { display: inline-block; padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }\r\n          .badge-alert { background: #fee2e2; color: #991b1b; }\r\n          .badge-event { background: #e9d5ff; color: #6b21a8; }\r\n          .badge-update { background: #dbeafe; color: #1e40af; }\r\n          .badge-development { background: #e0e7ff; color: #3730a3; }\r\n          .badge-health { background: #d1fae5; color: #065f46; }\r\n          .badge-notice { background: #fef3c7; color: #92400e; }\r\n          .announcement-content { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #059669; }\r\n          .footer { text-align: center; padding: 20px; color: #6b7280; font-size: 12px; border-radius: 0 0 10px 10px; background: #f9fafb; }\r\n          .unsubscribe { color: #6b7280; text-decoration: none; }\r\n        </style>\r\n      </head>\r\n      <body>\r\n        <div class=\"container\">\r\n          <div class=\"header\">\r\n            <h1>ðŸ”” New Announcement</h1>\r\n          </div>\r\n          <div class=\"content\">\r\n            <span class=\"badge badge-${data.category.toLowerCase()}\">${data.category.toUpperCase()}</span>\r\n            <h2 style=\"color: #111827; margin: 10px 0;\">${data.title}</h2>\r\n            <p style=\"color: #6b7280; font-size: 14px;\">ðŸ“… ${data.date}</p>\r\n            <p style=\"color: #4b5563; margin: 15px 0;\">${data.description}</p>\r\n            <div class=\"announcement-content\">\r\n              <p style=\"white-space: pre-wrap;\">${data.content}</p>\r\n            </div>\r\n          </div>\r\n          <div class=\"footer\">\r\n            <p>Â© ${new Date().getFullYear()} Local Government. All rights reserved.</p>\r\n            <p>You received this email because you subscribed to our announcements.</p>\r\n            <p><a href=\"${data.unsubscribeUrl}\" class=\"unsubscribe\">Unsubscribe from these emails</a></p>\r\n          </div>\r\n        </div>\r\n      </body>\r\n      </html>\r\n    `,\r\n  }),\r\n\r\n  news: (data: any) => ({\r\n    subject: `Latest News: ${data.title}`,\r\n    html: `\r\n      <!DOCTYPE html>\r\n      <html>\r\n      <head>\r\n        <style>\r\n          body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n          .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n          .header { background: linear-gradient(135deg, #059669 0%, #f97316 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\r\n          .content { background: #f9fafb; padding: 30px; }\r\n          .badge { display: inline-block; padding: 5px 10px; background: #dbeafe; color: #1e40af; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }\r\n          .news-image { width: 100%; max-width: 100%; height: auto; border-radius: 8px; margin: 20px 0; }\r\n          .news-content { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; }\r\n          .button { display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #059669 0%, #f97316 100%); color: white; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 20px 0; }\r\n          .footer { text-align: center; padding: 20px; color: #6b7280; font-size: 12px; border-radius: 0 0 10px 10px; background: #f9fafb; }\r\n          .unsubscribe { color: #6b7280; text-decoration: none; }\r\n        </style>\r\n      </head>\r\n      <body>\r\n        <div class=\"container\">\r\n          <div class=\"header\">\r\n            <h1>ðŸ“° Latest News</h1>\r\n          </div>\r\n          <div class=\"content\">\r\n            <span class=\"badge\">${data.category.toUpperCase()}</span>\r\n            <h2 style=\"color: #111827; margin: 10px 0;\">${data.title}</h2>\r\n            <p style=\"color: #6b7280; font-size: 14px;\"> ${data.published_at}</p>\r\n            <div class=\"news-content\">\r\n              <p style=\"white-space: pre-wrap;\">${data.content}</p>\r\n            </div>\r\n           \r\n          </div>\r\n          <div class=\"footer\">\r\n            <p>Â© ${new Date().getFullYear()} Local Government. All rights reserved.</p>\r\n            <p>You received this email because you subscribed to our news updates.</p>\r\n            <p><a href=\"${data.unsubscribeUrl}\" class=\"unsubscribe\">Unsubscribe from these emails</a></p>\r\n          </div>\r\n        </div>\r\n      </body>\r\n      </html>\r\n    `,\r\n  }),\r\n};\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const body = await request.json();\r\n    const { type, data } = body;\r\n\r\n    if (!type || !data) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Missing required fields: type, data' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Fetch all active subscribers from Laravel backend\r\n    const subscribersResponse = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/subscribers/active`);\r\n    \r\n    if (!subscribersResponse.ok) {\r\n      throw new Error('Failed to fetch subscribers');\r\n    }\r\n\r\n    const subscribersData = await subscribersResponse.json();\r\n    const subscribers = subscribersData.data || [];\r\n\r\n    if (subscribers.length === 0) {\r\n      return NextResponse.json({\r\n        success: true,\r\n        message: 'No active subscribers to notify',\r\n        results: { total: 0, success: 0, failed: 0 },\r\n      });\r\n    }\r\n\r\n    const template = emailTemplates[type as keyof typeof emailTemplates];\r\n    if (!template) {\r\n      return NextResponse.json(\r\n        { success: false, message: 'Invalid email type' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const results = {\r\n      success: [] as string[],\r\n      failed: [] as { email: string; error: string }[],\r\n    };\r\n\r\n    // Send emails to each subscriber\r\n    for (const subscriber of subscribers) {\r\n      try {\r\n        const recipientData = {\r\n          ...data,\r\n          unsubscribeUrl: `${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/unsubscribe?token=${subscriber.token}`,\r\n        };\r\n\r\n        const emailContent = template(recipientData);\r\n\r\n        const mailOptions = {\r\n          from: `\"Local Government\" <${process.env.SMTP_FROM}>`,\r\n          to: subscriber.email,\r\n          subject: emailContent.subject,\r\n          html: emailContent.html,\r\n        };\r\n\r\n        await transporter.sendMail(mailOptions);\r\n        results.success.push(subscriber.email);\r\n\r\n        // Small delay to avoid overwhelming SMTP server\r\n        await new Promise(resolve => setTimeout(resolve, 100));\r\n\r\n      } catch (error: any) {\r\n        console.error(`Failed to send to ${subscriber.email}:`, error.message);\r\n        results.failed.push({\r\n          email: subscriber.email,\r\n          error: error.message,\r\n        });\r\n      }\r\n    }\r\n\r\n    console.log('Bulk email results:', {\r\n      total: subscribers.length,\r\n      success: results.success.length,\r\n      failed: results.failed.length,\r\n    });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: 'Bulk email process completed',\r\n      results: {\r\n        total: subscribers.length,\r\n        success: results.success.length,\r\n        failed: results.failed.length,\r\n        details: results,\r\n      },\r\n    });\r\n\r\n  } catch (error: any) {\r\n    console.error('Error in bulk email:', error);\r\n    return NextResponse.json(\r\n      { success: false, message: 'Failed to send bulk emails', error: error.message },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}"],"names":[],"mappings":"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"}}]
}