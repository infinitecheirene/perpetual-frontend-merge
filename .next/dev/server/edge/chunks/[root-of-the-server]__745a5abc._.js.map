{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/perpetual_merged/perpetual_frontend/middleware.ts"],"sourcesContent":["// middleware.ts (root level)\r\nimport { NextResponse } from 'next/server'\r\nimport type { NextRequest } from 'next/server'\r\n\r\nexport async function middleware(request: NextRequest) {\r\n  const token = request.cookies.get('auth_token')?.value\r\n  const { pathname } = request.nextUrl\r\n\r\n  console.log('Middleware:', { pathname, hasToken: !!token })\r\n\r\n  // Public paths that don't require authentication\r\n  const publicPaths = [\r\n    '/',\r\n    '/login',\r\n    '/register',\r\n    '/announcements',\r\n    '/news',\r\n    '/services',\r\n    '/about',\r\n    '/contact',\r\n    '/cookies',\r\n    '/terms',\r\n    '/privacy'\r\n  ]\r\n  const isPublicPath = publicPaths.includes(pathname)\r\n\r\n  // API routes should be handled separately\r\n  const isApiRoute = pathname.startsWith('/api/')\r\n\r\n  // PWA files - CRITICAL for PWA to work\r\n  const isPWAFile = pathname === '/manifest.json' ||\r\n    pathname === '/sw.js' ||\r\n    pathname === '/workbox-' ||\r\n    pathname.startsWith('/workbox-') ||\r\n    pathname === '/swe-worker-' ||\r\n    pathname.startsWith('/swe-worker-')\r\n\r\n  // Static and public assets\r\n  const isPublicAsset = pathname.startsWith('/_next') ||\r\n    pathname.startsWith('/static') ||\r\n    pathname.match(/\\.(svg|png|jpg|jpeg|gif|webp|ico|json|js)$/)\r\n\r\n  // Don't process API routes, public assets, or PWA files\r\n  if (isApiRoute || isPublicAsset || isPWAFile) {\r\n    console.log('Middleware: Allowing asset/API/PWA:', pathname)\r\n    return NextResponse.next()\r\n  }\r\n\r\n  // If accessing protected route without token, redirect to login\r\n  if (!token && !isPublicPath) {\r\n    console.log('Middleware: No token, redirecting to login')\r\n    const loginUrl = new URL('/login', request.url)\r\n    loginUrl.searchParams.set('redirect', pathname)\r\n    return NextResponse.redirect(loginUrl)\r\n  }\r\n\r\n  // If has token and on login/register page, redirect based on role\r\n  if (token && (pathname === '/login' || pathname === '/register')) {\r\n    console.log('Middleware: User has token on login/register, checking role...')\r\n\r\n    try {\r\n      // Fetch user data to determine role\r\n      const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'\r\n      const response = await fetch(`${apiUrl}/api/auth/me`, {\r\n        headers: {\r\n          'Cookie': `auth_token=${token}`,\r\n          'Accept': 'application/json',\r\n        },\r\n        credentials: 'include',\r\n      })\r\n\r\n      if (response.ok) {\r\n        const data = await response.json()\r\n        const userRole = data.user?.role\r\n\r\n        console.log('Middleware: User role detected:', userRole)\r\n\r\n        // Redirect based on role\r\n        if (userRole === 'admin') {\r\n          console.log('Middleware: Redirecting admin to admin dashboard')\r\n          return NextResponse.redirect(new URL('/dashboard/admin/news', request.url))\r\n        } else if (userRole === 'member') {\r\n          console.log('Middleware: Redirecting member to member dashboard')\r\n          return NextResponse.redirect(new URL('/dashboard/member/certificate', request.url))\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Middleware: Error fetching user role:', error)\r\n    }\r\n\r\n    // Default redirect if role check fails\r\n    console.log('Middleware: Role check failed, redirecting to home')\r\n    return NextResponse.redirect(new URL('/login', request.url))\r\n  }\r\n\r\n  // Allow access to all other routes\r\n  console.log('Middleware: Allowing access')\r\n  return NextResponse.next()\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    /*\r\n     * Match all paths EXCEPT:\r\n     * - api routes\r\n     * - next internals\r\n     * - static files\r\n     * - PWA files\r\n     */\r\n    '/((?!api|_next/static|_next/image|favicon.ico|manifest.json|sw.js|workbox-.*|swe-worker-.*|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',\r\n  ],\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA,6BAA6B;AAC7B;AAAA;;AAGO,eAAe,WAAW,OAAoB;IACnD,MAAM,QAAQ,QAAQ,OAAO,CAAC,GAAG,CAAC,eAAe;IACjD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,QAAQ,GAAG,CAAC,eAAe;QAAE;QAAU,UAAU,CAAC,CAAC;IAAM;IAEzD,iDAAiD;IACjD,MAAM,cAAc;QAClB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACD,MAAM,eAAe,YAAY,QAAQ,CAAC;IAE1C,0CAA0C;IAC1C,MAAM,aAAa,SAAS,UAAU,CAAC;IAEvC,uCAAuC;IACvC,MAAM,YAAY,aAAa,oBAC7B,aAAa,YACb,aAAa,eACb,SAAS,UAAU,CAAC,gBACpB,aAAa,kBACb,SAAS,UAAU,CAAC;IAEtB,2BAA2B;IAC3B,MAAM,gBAAgB,SAAS,UAAU,CAAC,aACxC,SAAS,UAAU,CAAC,cACpB,SAAS,KAAK,CAAC;IAEjB,wDAAwD;IACxD,IAAI,cAAc,iBAAiB,WAAW;QAC5C,QAAQ,GAAG,CAAC,uCAAuC;QACnD,OAAO,0OAAY,CAAC,IAAI;IAC1B;IAEA,gEAAgE;IAChE,IAAI,CAAC,SAAS,CAAC,cAAc;QAC3B,QAAQ,GAAG,CAAC;QACZ,MAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,GAAG;QAC9C,SAAS,YAAY,CAAC,GAAG,CAAC,YAAY;QACtC,OAAO,0OAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,kEAAkE;IAClE,IAAI,SAAS,CAAC,aAAa,YAAY,aAAa,WAAW,GAAG;QAChE,QAAQ,GAAG,CAAC;QAEZ,IAAI;YACF,oCAAoC;YACpC,MAAM,SAAS,QAAQ,GAAG,CAAC,mBAAmB,IAAI;YAClD,MAAM,WAAW,MAAM,MAAM,GAAG,OAAO,YAAY,CAAC,EAAE;gBACpD,SAAS;oBACP,UAAU,CAAC,WAAW,EAAE,OAAO;oBAC/B,UAAU;gBACZ;gBACA,aAAa;YACf;YAEA,IAAI,SAAS,EAAE,EAAE;gBACf,MAAM,OAAO,MAAM,SAAS,IAAI;gBAChC,MAAM,WAAW,KAAK,IAAI,EAAE;gBAE5B,QAAQ,GAAG,CAAC,mCAAmC;gBAE/C,yBAAyB;gBACzB,IAAI,aAAa,SAAS;oBACxB,QAAQ,GAAG,CAAC;oBACZ,OAAO,0OAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,yBAAyB,QAAQ,GAAG;gBAC3E,OAAO,IAAI,aAAa,UAAU;oBAChC,QAAQ,GAAG,CAAC;oBACZ,OAAO,0OAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,iCAAiC,QAAQ,GAAG;gBACnF;YACF;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,yCAAyC;QACzD;QAEA,uCAAuC;QACvC,QAAQ,GAAG,CAAC;QACZ,OAAO,0OAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,UAAU,QAAQ,GAAG;IAC5D;IAEA,mCAAmC;IACnC,QAAQ,GAAG,CAAC;IACZ,OAAO,0OAAY,CAAC,IAAI;AAC1B;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;;;;;;KAMC,GACD;KACD;AACH"}}]
}